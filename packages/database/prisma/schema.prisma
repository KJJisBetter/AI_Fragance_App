generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String              @id @default(cuid())
  email        String              @unique
  username     String              @unique
  passwordHash String
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  feedbacks    AICategorFeedback[]
  battles      Battle[]
  collections  Collection[]

  @@map("users")
}

model Fragrance {
  id                 String              @id @default(cuid())
  name               String
  brand              String
  year               Int?
  concentration      String?
  topNotes           String[]
  middleNotes        String[]
  baseNotes          String[]
  aiSeasons          String[]
  aiOccasions        String[]
  aiMoods            String[]
  fragranticaSeasons String[]
  communityRating    Float?
  verified           Boolean             @default(false)
  longevity          Int?
  sillage            Int?
  projection         Int?
  prestigeScore      Float?              @default(0)  // Prestige score (community + brand + verification + age + notes)
  popularityScore    Float?              @default(0)  // Sales-based popularity (market share + trends + availability)
  relevanceScore     Float               @default(0)  // New relevance scoring for better search results
  lastEnhanced       DateTime?                        // Track when relevance was last calculated
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  feedbacks          AICategorFeedback[]
  battleItems        BattleItem[]
  collections        CollectionItem[]

  // Performance indexes for search operations
  @@index([name])
  @@index([brand])
  @@index([communityRating(sort: Desc)])
  @@index([prestigeScore(sort: Desc)])
  @@index([popularityScore(sort: Desc)])
  @@index([relevanceScore(sort: Desc)])  // New index for relevance scoring
  @@index([aiSeasons], type: Gin)
  @@index([aiOccasions], type: Gin)
  @@index([aiMoods], type: Gin)
  @@index([year])
  @@index([concentration])
  @@index([verified])
  @@index([brand, year])
  @@index([createdAt])
  @@map("fragrances")
}

model BrandPrestige {
  id           String   @id @default(cuid())
  brand        String   @unique
  tier         String   // luxury, high-end-designer, designer, niche, mass-market, unknown
  priceRange   String   // under-50, 50-150, 150-300, 300-500, 500+, unknown
  confidence   Float    // 0.1-1.0 confidence score from AI
  reasoning    String   // Brief explanation from AI
  researchedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tier])
  @@index([brand])
  @@map("brand_prestige")
}

model Collection {
  id          String           @id @default(cuid())
  userId      String
  name        String           @default("My Collection")
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  items       CollectionItem[]
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("collections")
}

model CollectionItem {
  id             String     @id @default(cuid())
  collectionId   String
  fragranceId    String
  personalRating Int?
  personalNotes  String?
  purchaseDate   DateTime?
  bottleSize     String?
  createdAt      DateTime   @default(now())
  collection     Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  fragrance      Fragrance  @relation(fields: [fragranceId], references: [id], onDelete: Cascade)

  @@unique([collectionId, fragranceId])
  @@map("collection_items")
}

model Battle {
  id          String       @id @default(cuid())
  userId      String
  title       String
  description String?
  status      BattleStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  completedAt DateTime?
  items       BattleItem[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("battles")
}

model BattleItem {
  id          String    @id @default(cuid())
  battleId    String
  fragranceId String
  position    Int
  votes       Int       @default(0)
  winner      Boolean   @default(false)
  battle      Battle    @relation(fields: [battleId], references: [id], onDelete: Cascade)
  fragrance   Fragrance @relation(fields: [fragranceId], references: [id], onDelete: Cascade)

  @@unique([battleId, fragranceId])
  @@map("battle_items")
}

model AICategorFeedback {
  id             String    @id @default(cuid())
  userId         String
  fragranceId    String
  aiSuggestion   Json
  userCorrection Json
  feedbackType   String
  createdAt      DateTime  @default(now())
  fragrance      Fragrance @relation(fields: [fragranceId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_categor_feedbacks")
}

enum BattleStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum BrandTier {
  LUXURY
  HIGH_END_DESIGNER
  DESIGNER
  NICHE
  MASS_MARKET
  UNKNOWN
}

enum PriceRange {
  UNDER_50
  RANGE_50_150
  RANGE_150_300
  RANGE_300_500
  OVER_500
  UNKNOWN
}
